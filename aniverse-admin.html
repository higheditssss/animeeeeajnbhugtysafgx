<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>HighEdits â€” Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Barlow+Condensed:wght@400;600;700;800;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
:root{
  --black:#000;--dark:#0a0a0a;--mid:#111;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.12);
  --white:#fff;--red:#888;--gold:#aaa;--green:#4ecdc4;--blue:#4a9eff;
  --grey:#444;--grey2:#666;--text:#999;
  --fd:'Barlow Condensed',sans-serif;--fs:'Playfair Display',serif;--fb:'Barlow',sans-serif;
}
/* Grey/black pattern overlay */
body::before{
  content:'';position:fixed;inset:0;pointer-events:none;z-index:0;
  background-image:
    linear-gradient(rgba(255,255,255,0.018) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,0.018) 1px,transparent 1px);
  background-size:40px 40px;
}
html{scroll-behavior:smooth;}
body{font-family:var(--fb);background:var(--black);color:var(--text);overflow-x:hidden;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;}
#root{position:relative;z-index:1;}
img{display:block;max-width:100%;}
*::-webkit-scrollbar{width:3px;height:3px;}
*::-webkit-scrollbar-track{background:transparent;}
*::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.09);}
input,select,button,textarea{font-family:inherit;}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px);}to{opacity:1;transform:translateY(0);}}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.94);}to{opacity:1;transform:scale(1);}}
@keyframes slideUp{from{opacity:0;transform:translateY(28px);}to{opacity:1;transform:translateY(0);}}
@keyframes spin{to{transform:rotate(360deg);}}
@keyframes glitch{0%,100%{transform:skewX(0) translateX(0);}15%{transform:skewX(-1deg) translateX(-3px);}30%{transform:skewX(1deg) translateX(3px);}60%{transform:skewX(.5deg) translateX(2px);}}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:0;}}
@keyframes pulse{0%,100%{opacity:.28;}50%{opacity:.85;}}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback,useMemo}=React;

/* â•â•â•â•â•â•â•â• CONFIG â€” no password stored here â•â•â•â•â•â•â•â• */
const STORAGE_KEY   = 'aniverse_v3_library';
const MUSIC_KEY     = 'highedits_music';
const PASS_HASH_KEY = 'aniverse_admin_hash';
const SESSION_KEY   = 'av_admin_auth';
const JIKAN         = 'https://api.jikan.moe/v4';

/* SHA-256 via native Web Crypto API */
async function sha256(text){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* Auth */
function getStoredHash(){return localStorage.getItem(PASS_HASH_KEY);}
async function setPassword(plain){const h=await sha256(plain);localStorage.setItem(PASS_HASH_KEY,h);return h;}
async function verifyPassword(plain){
  const stored=getStoredHash(); if(!stored) return false;
  return (await sha256(plain))===stored;
}
function checkSession(){return sessionStorage.getItem(SESSION_KEY)==='ok';}
function setSession(){sessionStorage.setItem(SESSION_KEY,'ok');}
function clearSession(){sessionStorage.removeItem(SESSION_KEY);}

/* Library */
function getLib(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');}catch{return[];}}
function saveLib(l){localStorage.setItem(STORAGE_KEY,JSON.stringify(l));}
function getMusic(){try{return JSON.parse(localStorage.getItem(MUSIC_KEY)||'[]');}catch{return[];}}
function saveMusic(m){localStorage.setItem(MUSIC_KEY,JSON.stringify(m));}

/* Mobile */
function useIsMobile(){
  const[m,setM]=useState(()=>window.innerWidth<768);
  useEffect(()=>{const h=()=>setM(window.innerWidth<768);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);},[]);
  return m;
}

/* Jikan */
const apiCache={};
async function jikan(path){
  if(apiCache[path])return apiCache[path];
  try{const r=await fetch(JIKAN+path);const d=await r.json();apiCache[path]=d;return d;}
  catch{return null;}
}
function mapJikanAnime(a){
  return{
    mal_id:a.mal_id,title:a.title,title_english:a.title_english||null,
    image:a.images?.jpg?.large_image_url||a.images?.jpg?.image_url||'',
    image_sm:a.images?.jpg?.small_image_url||a.images?.jpg?.image_url||'',
    score:a.score||null,episodes:a.episodes||null,
    year:a.aired?.prop?.from?.year||null,
    genres:(a.genres||[]).map(g=>g.name),
    synopsis:a.synopsis||'',type:a.type||'',
  };
}

const STATUS_META={
  watching:    {label:'UrmÄƒresc', color:'#7c8fff',bg:'rgba(124,143,255,0.13)'},
  completed:   {label:'Terminat', color:'#4ecdc4',bg:'rgba(78,205,196,0.13)'},
  plan_to_watch:{label:'Plan',    color:'#ff6b9d',bg:'rgba(255,107,157,0.13)'},
  dropped:     {label:'Dropped',  color:'#ff4444',bg:'rgba(255,68,68,0.13)'},
};
const MAL_STATUS={1:'watching',2:'completed',3:'plan_to_watch',4:'dropped',6:'plan_to_watch'};

/* â•â•â• SPINNER â•â•â• */
function Spin({size=16,color='var(--red)'}){
  return <span style={{display:'inline-block',width:size,height:size,border:'2px solid rgba(255,255,255,0.08)',borderTopColor:color,borderRadius:'50%',animation:'spin .7s linear infinite',verticalAlign:'middle',flexShrink:0}}/>;
}

/* â•â•â• TOAST â•â•â• */
function Toast({message,type,visible}){
  return <div style={{position:'fixed',bottom:24,right:16,zIndex:9999,maxWidth:340,pointerEvents:'none',background:'var(--mid)',border:'1px solid var(--border)',borderLeft:`3px solid ${type==='ok'?'var(--green)':type==='info'?'var(--blue)':'var(--red)'}`,padding:'12px 18px',fontFamily:'var(--fd)',fontWeight:700,fontSize:13,letterSpacing:1,textTransform:'uppercase',color:type==='ok'?'var(--green)':type==='info'?'var(--blue)':'#ff7777',transform:visible?'translateX(0)':'translateX(130%)',transition:'transform .35s cubic-bezier(.34,1.56,.64,1)'}}>{message}</div>;
}
function useToast(){
  const[s,set]=useState({message:'',type:'ok',visible:false});
  const t=useRef(null);
  const show=useCallback((msg,type='ok')=>{clearTimeout(t.current);set({message:msg,type,visible:true});t.current=setTimeout(()=>set(x=>({...x,visible:false})),3500);},[]);
  return[s,show];
}

/* â•â•â• CORNER ACCENTS â•â•â• */
function Corners(){
  return <>{[{top:0,left:0,borderTop:'2px solid var(--red)',borderLeft:'2px solid var(--red)'},{top:0,right:0,borderTop:'2px solid var(--red)',borderRight:'2px solid var(--red)'},{bottom:0,left:0,borderBottom:'2px solid var(--red)',borderLeft:'2px solid var(--red)'},{bottom:0,right:0,borderBottom:'2px solid var(--red)',borderRight:'2px solid var(--red)'}].map((s,i)=><div key={i} style={{position:'absolute',width:28,height:28,...s}}/>)}</>;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETUP SCREEN â€” first time, set password
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function SetupScreen({onSetup}){
  const[p1,setP1]=useState('');const[p2,setP2]=useState('');
  const[err,setErr]=useState('');const[loading,setLoading]=useState(false);
  const[glitch,setGlitch]=useState(false);
  const mob=useIsMobile();const ref=useRef(null);
  useEffect(()=>{ref.current?.focus();const id=setInterval(()=>setGlitch(g=>!g),4000);return()=>clearInterval(id);},[]);
  const submit=async()=>{
    if(p1.length<6){setErr('Parola trebuie sÄƒ aibÄƒ minim 6 caractere');return;}
    if(p1!==p2){setErr('Parolele nu se potrivesc');return;}
    setLoading(true);await setPassword(p1);setSession();onSetup();
  };
  return(
    <div style={{minHeight:'100vh',background:'var(--black)',display:'flex',alignItems:'center',justifyContent:'center',padding:16,position:'relative',overflow:'hidden'}}>
      <div style={{position:'absolute',inset:0,background:'repeating-linear-gradient(0deg,rgba(255,255,255,0.011) 0,rgba(255,255,255,0.011) 1px,transparent 1px,transparent 4px)',pointerEvents:'none'}}/>
      <Corners/>
      <div style={{position:'relative',zIndex:2,width:'100%',maxWidth:440,padding:mob?'36px 24px':'52px 44px',border:'1px solid rgba(255,255,255,0.06)',background:'rgba(255,255,255,0.015)',backdropFilter:'blur(10px)',borderRadius:mob?12:0,animation:'scaleIn .5s ease'}}>
        <div style={{position:'absolute',top:0,left:0,right:0,height:2,background:'var(--red)',animation:'pulse 2.2s ease infinite',borderRadius:mob?'12px 12px 0 0':0}}/>
        <div style={{textAlign:'center',marginBottom:36}}>
          <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?24:28,letterSpacing:7,textTransform:'uppercase',color:'var(--white)',animation:glitch?'glitch .25s ease':'none',display:'inline-block'}}>HIGH<span style={{color:'var(--grey2)'}}>EDITS</span></div>
          <div style={{fontFamily:'var(--fd)',fontWeight:600,fontSize:10,letterSpacing:4,textTransform:'uppercase',color:'rgba(255,255,255,0.18)',marginTop:8}}>SETARE PAROLÄ‚ ADMIN</div>
        </div>
        <div style={{background:'rgba(74,158,255,0.07)',border:'1px solid rgba(74,158,255,0.2)',borderLeft:'3px solid var(--blue)',padding:'12px 16px',marginBottom:24}}>
          <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:1,textTransform:'uppercase',color:'var(--blue)',marginBottom:4}}>Prima rulare â€” fÄƒrÄƒ parolÄƒ Ã®n cod!</div>
          <div style={{fontSize:12,color:'rgba(255,255,255,0.45)',lineHeight:1.65}}>Parola ta va fi salvatÄƒ ca <strong style={{color:'rgba(255,255,255,0.6)'}}>hash SHA-256</strong> Ã®n browser. Nimeni altcineva nu o poate citi, nici din codul sursÄƒ.</div>
        </div>
        {[['ParolÄƒ nouÄƒ',p1,setP1,ref,'Minim 6 caractere...'],['ConfirmÄƒ parola',p2,setP2,null,'RepetÄƒ parola...']].map(([l,v,s,r,ph])=>(
          <div key={l} style={{marginBottom:16}}>
            <label style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:3,textTransform:'uppercase',color:'var(--grey2)',marginBottom:7,display:'block'}}>{l}</label>
            <input ref={r} type="password" value={v} onChange={e=>{s(e.target.value);setErr('');}} onKeyDown={e=>e.key==='Enter'&&submit()} placeholder={ph} style={{width:'100%',background:'rgba(0,0,0,0.6)',border:'1px solid var(--border)',borderBottom:'2px solid rgba(255,255,255,0.18)',padding:'13px 16px',color:'var(--white)',fontSize:15,letterSpacing:3,outline:'none',WebkitAppearance:'none'}}/>
          </div>
        ))}
        <div style={{height:18,marginBottom:10,fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:1,color:'var(--red)',opacity:err?1:0,transition:'opacity .2s'}}>{err||'â€Œ'}</div>
        <button onClick={submit} disabled={loading||!p1||!p2} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:4,textTransform:'uppercase',background:loading||!p1||!p2?'rgba(230,48,34,0.28)':'var(--red)',color:'white',border:'none',padding:15,cursor:loading||!p1||!p2?'not-allowed':'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
          {loading?<><Spin size={14}/>SALVEZ...</>:'âœ“ SETEAZÄ‚ PAROLA'}
        </button>
        <div style={{marginTop:24,textAlign:'center',fontFamily:'var(--fd)',fontSize:9,letterSpacing:2,color:'rgba(255,255,255,0.08)',textTransform:'uppercase'}}>PaginÄƒ privatÄƒ Â· ParolÄƒ hashed SHA-256 Â· FÄƒrÄƒ text plain Ã®n cod</div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function LoginScreen({onLogin}){
  const[pass,setPass]=useState('');const[err,setErr]=useState(false);
  const[shake,setShake]=useState(false);const[loading,setLoading]=useState(false);
  const[glitch,setGlitch]=useState(false);
  const mob=useIsMobile();const ref=useRef(null);
  useEffect(()=>{ref.current?.focus();const id=setInterval(()=>setGlitch(g=>!g),3800);return()=>clearInterval(id);},[]);
  const submit=async()=>{
    if(!pass)return; setLoading(true);
    const ok=await verifyPassword(pass);
    if(ok){setSession();onLogin();}
    else{setErr(true);setShake(true);setLoading(false);setPass('');setTimeout(()=>setShake(false),500);setTimeout(()=>setErr(false),2500);ref.current?.focus();}
  };
  return(
    <div style={{minHeight:'100vh',background:'var(--black)',display:'flex',alignItems:'center',justifyContent:'center',padding:16,position:'relative',overflow:'hidden'}}>
      <div style={{position:'absolute',inset:0,background:'repeating-linear-gradient(0deg,rgba(255,255,255,0.011) 0,rgba(255,255,255,0.011) 1px,transparent 1px,transparent 4px)',pointerEvents:'none'}}/>
      <Corners/>
      <div style={{position:'relative',zIndex:2,width:'100%',maxWidth:420,padding:mob?'36px 24px':'52px 44px',border:'1px solid rgba(255,255,255,0.06)',background:'rgba(255,255,255,0.015)',backdropFilter:'blur(10px)',animation:'scaleIn .5s ease',borderRadius:mob?12:0,transform:shake?'translateX(-6px)':'translateX(0)',transition:shake?'transform 0s':'transform .4s cubic-bezier(.36,.07,.19,.97)'}}>
        <div style={{position:'absolute',top:0,left:0,right:0,height:2,background:'var(--red)',animation:'pulse 2.2s ease infinite',borderRadius:mob?'12px 12px 0 0':0}}/>
        <div style={{textAlign:'center',marginBottom:44}}>
          <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?26:30,letterSpacing:7,textTransform:'uppercase',color:'var(--white)',animation:glitch?'glitch .25s ease':'none',display:'inline-block'}}>HIGH<span style={{color:'var(--grey2)'}}>EDITS</span></div>
          <div style={{fontFamily:'var(--fd)',fontWeight:600,fontSize:10,letterSpacing:4,textTransform:'uppercase',color:'rgba(255,255,255,0.18)',marginTop:8}}>ADMIN ACCESS REQUIRED</div>
        </div>
        <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:28}}>
          <div style={{flex:1,height:1,background:'var(--border)'}}/>
          <div style={{fontFamily:'var(--fd)',fontSize:10,letterSpacing:3,color:'var(--grey)',textTransform:'uppercase'}}>AUTH</div>
          <div style={{flex:1,height:1,background:'var(--border)'}}/>
        </div>
        <label style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:3,textTransform:'uppercase',color:'var(--grey2)',marginBottom:8,display:'block'}}>ParolÄƒ</label>
        <div style={{position:'relative',marginBottom:8}}>
          <input ref={ref} type="password" value={pass} onChange={e=>{setPass(e.target.value);setErr(false);}} onKeyDown={e=>e.key==='Enter'&&submit()} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={{width:'100%',background:'rgba(0,0,0,0.6)',border:'1px solid',borderColor:err?'var(--red)':'rgba(255,255,255,0.1)',borderBottom:`2px solid ${err?'var(--red)':'rgba(255,255,255,0.2)'}`,padding:'13px 44px 13px 16px',color:'var(--white)',fontSize:mob?16:18,letterSpacing:4,outline:'none',WebkitAppearance:'none'}}/>
          <span style={{position:'absolute',right:14,top:'50%',transform:'translateY(-50%)',width:2,height:18,background:'var(--red)',animation:'blink 1s ease infinite',display:pass?'none':'block'}}/>
        </div>
        <div style={{height:18,marginBottom:12,fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:1,color:'var(--red)',opacity:err?1:0,transition:'opacity .2s'}}>âœ— ACCES REFUZAT</div>
        <button onClick={submit} disabled={loading||!pass} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:13,letterSpacing:4,textTransform:'uppercase',background:loading||!pass?'rgba(230,48,34,0.28)':'var(--red)',color:'white',border:'none',padding:15,cursor:loading||!pass?'not-allowed':'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
          {loading?<><Spin size={14}/>AUTENTIFICARE...</>:'â†’ INTRÄ‚ ÃN ADMIN'}
        </button>
        <div style={{marginTop:28,textAlign:'center',fontFamily:'var(--fd)',fontSize:9,letterSpacing:2,color:'rgba(255,255,255,0.08)',textTransform:'uppercase'}}>PaginÄƒ privatÄƒ Â· SHA-256 hash auth</div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAL IMPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MalImport({library,onImport,onClose,showToast}){
  const[uname,setUname]=useState('');
  const[phase,setPhase]=useState('idle');
  const[preview,setPreview]=useState([]);
  const[sel,setSel]=useState(new Set());
  const[loadMsg,setLoadMsg]=useState('');
  const[errMsg,setErrMsg]=useState('');
  const mob=useIsMobile();

  const existIds=useMemo(()=>new Set(library.map(a=>a.mal_id)),[library]);

  const fetchList=async()=>{
    if(!uname.trim()){setErrMsg('Introdu un username MAL');return;}
    setPhase('loading');setErrMsg('');setPreview([]);
    try{
      let page=1,all=[],hasMore=true;
      while(hasMore){
        setLoadMsg(`Se Ã®ncarcÄƒ pagina ${page}...`);
        const d=await jikan(`/users/${encodeURIComponent(uname.trim())}/animelist?page=${page}`);
        if(!d){throw new Error('Eroare la conexiune cu Jikan API');}
        if(d.error||d.status===404){throw new Error(d.message||'Username invalid sau lista privatÄƒ');}
        const data=d.data||[];
        all=[...all,...data];
        hasMore=!!(d.pagination?.has_next_page);
        page++;
        if(hasMore) await new Promise(r=>setTimeout(r,650));
      }
      const mapped=all.map(e=>{
        const a=e.node||e;
        return{
          mal_id:a.mal_id,title:a.title,title_english:a.title_english||null,
          image:a.images?.jpg?.large_image_url||a.images?.jpg?.image_url||e.images?.jpg?.large_image_url||'',
          image_sm:a.images?.jpg?.small_image_url||e.images?.jpg?.small_image_url||'',
          score:a.score||null,episodes:a.episodes||null,
          year:a.aired?.prop?.from?.year||null,
          genres:(a.genres||[]).map(g=>g.name),synopsis:a.synopsis||'',type:a.type||'',
          status:MAL_STATUS[e.watching_status]||'plan_to_watch',
          userScore:e.score||null,epsWatched:e.watched_episodes||0,
          notes:e.tags||'',addedAt:Date.now(),_fromMAL:true,
        };
      }).filter(a=>a.mal_id);
      setPreview(mapped);
      setSel(new Set(mapped.filter(a=>!existIds.has(a.mal_id)).map(a=>a.mal_id)));
      setPhase('preview');
    }catch(e){setErrMsg(e.message||'Eroare necunoscutÄƒ');setPhase('error');}
  };

  const toggle=id=>setSel(s=>{const n=new Set(s);n.has(id)?n.delete(id):n.add(id);return n;});
  const selAll=()=>setSel(new Set(preview.filter(a=>!existIds.has(a.mal_id)).map(a=>a.mal_id)));
  const desel=()=>setSel(new Set());

  const doImport=()=>{
    const items=preview.filter(a=>sel.has(a.mal_id));
    onImport(items);showToast(`âœ“ ${items.length} anime importate!`,'ok');
    setPhase('done');setTimeout(onClose,1600);
  };

  const newCnt=preview.filter(a=>!existIds.has(a.mal_id)).length;
  const dupCnt=preview.filter(a=>existIds.has(a.mal_id)).length;
  const smC={watching:'#7c8fff',completed:'#4ecdc4',plan_to_watch:'#ff6b9d',dropped:'#ff4444'};
  const smL={watching:'UrmÄƒresc',completed:'Terminat',plan_to_watch:'Plan',dropped:'Dropped'};

  return(
    <div style={{position:'fixed',inset:0,zIndex:900,background:'rgba(0,0,0,0.92)',backdropFilter:'blur(7px)',display:'flex',alignItems:mob?'flex-end':'center',justifyContent:'center',padding:mob?0:24,animation:'fadeIn .2s'}} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={{background:'var(--dark)',border:mob?'none':'1px solid var(--border)',borderTop:'2px solid var(--blue)',maxWidth:mob?'100%':680,width:'100%',maxHeight:mob?'92vh':'88vh',overflowY:'auto',borderRadius:mob?'18px 18px 0 0':0,animation:mob?'slideUp .3s ease':'scaleIn .25s ease',paddingBottom:'env(safe-area-inset-bottom,0px)'}}>
        {mob&&<div style={{display:'flex',justifyContent:'center',padding:'12px 0 4px'}}><div style={{width:36,height:4,background:'rgba(255,255,255,0.12)',borderRadius:2}}/></div>}
        <div style={{padding:mob?'12px 16px 0':'22px 26px 0',display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:16}}>
          <div>
            <h2 style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?20:26,letterSpacing:1,textTransform:'uppercase',color:'var(--white)',display:'flex',alignItems:'center',gap:8}}><span style={{color:'var(--blue)'}}>â†“</span> Import MyAnimeList</h2>
            <p style={{fontSize:12,color:'var(--grey2)',marginTop:3}}>ImportÄƒ lista publicÄƒ a oricÄƒrui cont MAL via Jikan API â€” gratuit, fÄƒrÄƒ autentificare</p>
          </div>
          <button onClick={onClose} style={{background:'none',border:'none',color:'var(--grey2)',fontSize:22,cursor:'pointer',flexShrink:0,lineHeight:1}}>âœ•</button>
        </div>

        <div style={{padding:mob?'14px 16px 24px':'0 26px 26px'}}>
          {/* Search row */}
          <div style={{display:'flex',gap:8,marginTop:mob?0:18,marginBottom:18}}>
            <input value={uname} onChange={e=>{setUname(e.target.value);setPhase('idle');setErrMsg('');}} onKeyDown={e=>e.key==='Enter'&&fetchList()} placeholder="Username MyAnimeList (ex: Nekomata1037)" style={{flex:1,background:'rgba(0,0,0,0.55)',border:'1px solid var(--border)',borderBottom:'2px solid var(--blue)',padding:'12px 14px',color:'var(--white)',fontSize:14,outline:'none',WebkitAppearance:'none'}}/>
            <button onClick={fetchList} disabled={phase==='loading'} style={{fontFamily:'var(--fd)',fontWeight:800,fontSize:11,letterSpacing:3,textTransform:'uppercase',background:phase==='loading'?'rgba(74,158,255,0.25)':'var(--blue)',color:'white',border:'none',padding:'0 18px',cursor:phase==='loading'?'not-allowed':'pointer',flexShrink:0,display:'flex',alignItems:'center',gap:6,whiteSpace:'nowrap'}}>
              {phase==='loading'?<><Spin size={12} color="white"/>Caut...</>:'CAUTÄ‚'}
            </button>
          </div>

          {phase==='idle'&&(
            <div style={{background:'rgba(74,158,255,0.06)',border:'1px solid rgba(74,158,255,0.18)',borderLeft:'3px solid var(--blue)',padding:'14px 16px'}}>
              <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:2,textTransform:'uppercase',color:'var(--blue)',marginBottom:6}}>InstrucÈ›iuni</div>
              <div style={{fontSize:12,color:'rgba(255,255,255,0.45)',lineHeight:1.75}}>
                â‘  Introdu username-ul contului MyAnimeList<br/>
                â‘¡ Lista trebuie sÄƒ fie <strong style={{color:'rgba(255,255,255,0.65)'}}>PublicÄƒ</strong> Ã®n MAL Settings â†’ Privacy<br/>
                â‘¢ Selectezi anime-urile dorite (pre-selectate cele noi)<br/>
                â‘£ Status, scor È™i episoade se copiazÄƒ automat
              </div>
            </div>
          )}

          {phase==='loading'&&(
            <div style={{textAlign:'center',padding:'40px 20px',color:'var(--grey2)'}}>
              <Spin size={36} color="var(--blue)"/>
              <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:12,letterSpacing:3,textTransform:'uppercase',marginTop:16,color:'var(--blue)'}}>{loadMsg||'Se Ã®ncarcÄƒ...'}</div>
              <div style={{fontSize:12,color:'var(--grey2)',marginTop:8}}>Jikan API are rate limiting â€” poate dura cÃ¢teva secunde</div>
            </div>
          )}

          {phase==='error'&&(
            <div style={{background:'rgba(230,48,34,0.08)',border:'1px solid rgba(230,48,34,0.25)',borderLeft:'3px solid var(--red)',padding:'14px 16px'}}>
              <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:12,letterSpacing:1,textTransform:'uppercase',color:'var(--red)',marginBottom:4}}>âœ— Eroare import</div>
              <div style={{fontSize:13,color:'rgba(255,255,255,0.5)',marginBottom:8}}>{errMsg}</div>
              <div style={{fontSize:11,color:'rgba(255,255,255,0.28)'}}>VerificÄƒ: username corect? Lista publicÄƒ? (MAL â†’ Settings â†’ Privacy â†’ Anime List = Public)</div>
            </div>
          )}

          {phase==='done'&&(
            <div style={{textAlign:'center',padding:'40px 20px'}}>
              <div style={{fontSize:48,marginBottom:12}}>âœ…</div>
              <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:24,letterSpacing:1,textTransform:'uppercase',color:'var(--green)'}}>Import reuÈ™it!</div>
            </div>
          )}

          {phase==='preview'&&preview.length>0&&(
            <div>
              {/* Summary cards */}
              <div style={{display:'grid',gridTemplateColumns:'repeat(4,1fr)',gap:8,marginBottom:14}}>
                {Object.entries(smL).map(([k,lbl])=>{
                  const cnt=preview.filter(a=>a.status===k).length;
                  return cnt>0?<div key={k} style={{padding:'8px 4px',background:'rgba(0,0,0,0.35)',border:`1px solid ${smC[k]}22`,textAlign:'center'}}><div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:22,color:smC[k]}}>{cnt}</div><div style={{fontFamily:'var(--fd)',fontSize:9,letterSpacing:1.5,textTransform:'uppercase',color:smC[k],opacity:0.7}}>{lbl}</div></div>:null;
                })}
              </div>
              {/* Header row */}
              <div style={{display:'flex',gap:10,marginBottom:10,alignItems:'center',flexWrap:'wrap'}}>
                <div style={{flex:1}}>
                  <span style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:14,color:'var(--white)'}}>{preview.length} anime gÄƒsite</span>
                  <span style={{fontFamily:'var(--fd)',fontSize:12,color:'var(--green)',marginLeft:10}}>+{newCnt} noi</span>
                  {dupCnt>0&&<span style={{fontFamily:'var(--fd)',fontSize:12,color:'var(--grey2)',marginLeft:8}}>{dupCnt} deja existente</span>}
                </div>
                <button onClick={selAll} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:2,textTransform:'uppercase',background:'none',border:'1px solid rgba(78,205,196,0.3)',color:'var(--green)',padding:'6px 12px',cursor:'pointer'}}>âœ“ Noi</button>
                <button onClick={desel} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:2,textTransform:'uppercase',background:'none',border:'1px solid var(--border)',color:'var(--grey2)',padding:'6px 12px',cursor:'pointer'}}>âœ— Reset</button>
              </div>
              {/* List */}
              <div style={{maxHeight:mob?260:320,overflowY:'auto',border:'1px solid var(--border)',marginBottom:14}}>
                {preview.map(a=>{
                  const inLib=existIds.has(a.mal_id);const isSel=sel.has(a.mal_id);const sc=smC[a.status]||'#888';const sl=smL[a.status]||'';
                  return(
                    <div key={a.mal_id} onClick={()=>!inLib&&toggle(a.mal_id)} style={{display:'flex',gap:10,padding:'9px 12px',borderBottom:'1px solid rgba(255,255,255,0.04)',cursor:inLib?'default':'pointer',background:isSel&&!inLib?'rgba(74,158,255,0.06)':inLib?'rgba(255,255,255,0.01)':'transparent',transition:'background .15s',alignItems:'center'}}>
                      <div style={{width:17,height:17,border:`1.5px solid ${inLib?'var(--grey)':isSel?'var(--blue)':'rgba(255,255,255,0.18)'}`,background:isSel&&!inLib?'var(--blue)':inLib?'rgba(78,205,196,0.15)':'transparent',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,transition:'all .15s'}}>
                        {inLib?<span style={{color:'var(--green)',fontSize:10,lineHeight:1}}>âœ“</span>:isSel?<span style={{color:'white',fontSize:10,lineHeight:1}}>âœ“</span>:null}
                      </div>
                      <img src={a.image_sm||a.image} style={{width:30,height:43,objectFit:'cover',flexShrink:0,opacity:inLib?0.35:1}} alt=""/>
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:13,color:inLib?'rgba(255,255,255,0.3)':'var(--white)',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{a.title_english||a.title}</div>
                        <div style={{display:'flex',gap:7,marginTop:2,flexWrap:'wrap',alignItems:'center'}}>
                          <span style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:9,letterSpacing:1.5,textTransform:'uppercase',padding:'1px 6px',border:`1px solid ${sc}`,color:sc}}>{sl}</span>
                          {a.userScore&&<span style={{fontFamily:'var(--fd)',fontSize:11,color:'var(--gold)',fontWeight:700}}>â˜… {a.userScore}</span>}
                          {a.epsWatched>0&&<span style={{fontSize:11,color:'var(--grey2)'}}>ğŸ“º {a.epsWatched}{a.episodes?'/'+a.episodes:''}</span>}
                          {inLib&&<span style={{fontFamily:'var(--fd)',fontSize:9,letterSpacing:1,textTransform:'uppercase',color:'var(--green)'}}>ExistÄƒ deja</span>}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
              <button onClick={doImport} disabled={sel.size===0} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:3,textTransform:'uppercase',background:sel.size===0?'rgba(74,158,255,0.18)':'var(--blue)',color:'white',border:'none',padding:14,cursor:sel.size===0?'not-allowed':'pointer',display:'flex',alignItems:'center',justifyContent:'center',gap:8}}>
                â†“ IMPORTÄ‚ {sel.size} ANIME SELECTATE
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHANGE PASSWORD MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function ChangePassModal({onClose,showToast}){
  const[cur,setCur]=useState('');const[p1,setP1]=useState('');const[p2,setP2]=useState('');
  const[err,setErr]=useState('');const[loading,setLoading]=useState(false);
  const mob=useIsMobile();
  const submit=async()=>{
    if(!await verifyPassword(cur)){setErr('Parola curentÄƒ e incorectÄƒ');return;}
    if(p1.length<6){setErr('Parola nouÄƒ trebuie sÄƒ aibÄƒ minim 6 caractere');return;}
    if(p1!==p2){setErr('Parolele noi nu se potrivesc');return;}
    setLoading(true);await setPassword(p1);
    showToast('âœ“ Parola schimbatÄƒ cu succes!','ok');onClose();
  };
  return(
    <div style={{position:'fixed',inset:0,zIndex:950,background:'rgba(0,0,0,0.9)',backdropFilter:'blur(5px)',display:'flex',alignItems:mob?'flex-end':'center',justifyContent:'center',padding:mob?0:24,animation:'fadeIn .2s'}} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={{background:'var(--mid)',border:'1px solid var(--border)',borderTop:'2px solid var(--gold)',maxWidth:420,width:'100%',padding:mob?'20px 16px 28px':'28px',animation:mob?'slideUp .3s':'scaleIn .25s',position:'relative',borderRadius:mob?'16px 16px 0 0':0,paddingBottom:'calc(env(safe-area-inset-bottom,0px) + 28px)'}}>
        <button onClick={onClose} style={{position:'absolute',top:14,right:14,background:'none',border:'none',color:'var(--grey2)',fontSize:20,cursor:'pointer',lineHeight:1}}>âœ•</button>
        <h3 style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:22,letterSpacing:1,textTransform:'uppercase',color:'var(--white)',marginBottom:20}}>ğŸ”‘ SchimbÄƒ Parola</h3>
        {[['Parola curentÄƒ',cur,setCur,'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'],['Parola nouÄƒ (min 6 caract.)',p1,setP1,'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢'],['ConfirmÄƒ parola nouÄƒ',p2,setP2,'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢']].map(([l,v,s,ph])=>(
          <div key={l} style={{marginBottom:14}}>
            <label style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:3,textTransform:'uppercase',color:'var(--grey2)',marginBottom:6,display:'block'}}>{l}</label>
            <input type="password" value={v} onChange={e=>{s(e.target.value);setErr('');}} onKeyDown={e=>e.key==='Enter'&&submit()} placeholder={ph} style={{width:'100%',background:'rgba(0,0,0,0.55)',border:'1px solid var(--border)',borderBottom:'2px solid rgba(255,255,255,0.12)',padding:'11px 13px',color:'var(--white)',fontSize:14,letterSpacing:3,outline:'none',WebkitAppearance:'none'}}/>
          </div>
        ))}
        {err&&<div style={{fontFamily:'var(--fd)',fontSize:11,letterSpacing:1,color:'var(--red)',marginBottom:12,textTransform:'uppercase'}}>{err}</div>}
        <button onClick={submit} disabled={loading} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:3,textTransform:'uppercase',background:loading?'rgba(255,209,102,0.25)':'var(--gold)',color:'var(--black)',border:'none',padding:14,cursor:loading?'wait':'pointer',marginTop:6}}>
          {loading?'SE SCHIMBÄ‚...':'SCHIMBÄ‚ PAROLA'}
        </button>
      </div>
    </div>
  );
}

/* â•â•â• Shared form styles â•â•â• */
const inp={width:'100%',background:'rgba(0,0,0,0.55)',border:'1px solid var(--border)',borderBottom:'2px solid rgba(255,255,255,0.12)',padding:'11px 13px',color:'var(--white)',fontSize:14,outline:'none',transition:'border-color .2s',marginBottom:0,WebkitAppearance:'none'};
const lbl={fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:3,textTransform:'uppercase',color:'var(--grey2)',marginBottom:7,display:'block'};

function SearchDrop({results,loading,onSelect}){
  if(!loading&&!results.length) return null;
  return(
    <div style={{position:'absolute',top:'100%',left:0,right:0,background:'rgba(5,5,5,0.99)',border:'1px solid var(--border)',borderTop:'2px solid var(--red)',zIndex:300,maxHeight:300,overflowY:'auto'}}>
      {loading?<div style={{padding:'14px 16px',color:'var(--grey2)',fontSize:13,display:'flex',alignItems:'center',gap:8}}><Spin/>Caut...</div>
      :results.map(a=>(
        <div key={a.mal_id} onClick={()=>onSelect(a)} style={{display:'flex',gap:12,padding:'10px 14px',borderBottom:'1px solid rgba(255,255,255,0.03)',cursor:'pointer',alignItems:'center'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(255,255,255,0.03)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>
          <img src={a.image_sm} style={{width:32,height:46,objectFit:'cover',flexShrink:0}} alt=""/>
          <div style={{flex:1,minWidth:0}}><div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:14,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',color:'var(--white)'}}>{a.title}</div><div style={{fontSize:11,color:'var(--grey2)',marginTop:2}}>{a.type} â€¢ â˜… {a.score||'N/A'} â€¢ {a.episodes||'?'} ep</div></div>
          <div style={{color:'var(--red)',fontSize:20,fontWeight:700,flexShrink:0}}>+</div>
        </div>
      ))}
    </div>
  );
}

function EditModal({anime,onSave,onClose}){
  const[status,setStatus]=useState(anime.status||'watching');
  const[score,setScore]=useState(anime.userScore||'');
  const[eps,setEps]=useState(anime.epsWatched||0);
  const[notes,setNotes]=useState(anime.notes||'');
  const mob=useIsMobile();
  return(
    <div style={{position:'fixed',inset:0,zIndex:800,background:'rgba(0,0,0,0.9)',backdropFilter:'blur(6px)',display:'flex',alignItems:mob?'flex-end':'center',justifyContent:'center',padding:mob?0:24,animation:'fadeIn .2s'}} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={{background:'var(--mid)',border:'1px solid var(--border)',borderTop:'2px solid var(--red)',maxWidth:460,width:'100%',padding:mob?'20px 16px 28px':'28px',animation:mob?'slideUp .3s':'scaleIn .25s',position:'relative',borderRadius:mob?'16px 16px 0 0':0,paddingBottom:'calc(env(safe-area-inset-bottom,0px) + '+(mob?'28':'0')+'px)'}}>
        <button onClick={onClose} style={{position:'absolute',top:14,right:14,background:'none',border:'none',color:'var(--grey2)',fontSize:20,cursor:'pointer',lineHeight:1}}>âœ•</button>
        <div style={{display:'flex',gap:12,marginBottom:20,alignItems:'flex-start'}}><img src={anime.image} style={{width:48,height:68,objectFit:'cover',flexShrink:0}} alt=""/><div><div style={{fontFamily:'var(--fd)',fontWeight:800,fontSize:16,lineHeight:1.2,color:'var(--white)',marginBottom:3}}>{anime.title_english||anime.title}</div><div style={{fontSize:12,color:'var(--grey2)'}}>{anime.type} â€¢ {anime.episodes||'?'} ep</div></div></div>
        <label style={lbl}>Status</label>
        <select value={status} onChange={e=>setStatus(e.target.value)} style={{...inp,marginBottom:14}}>
          <option value="watching">ğŸŸ£ UrmÄƒresc</option><option value="completed">ğŸ”µ Terminat</option><option value="plan_to_watch">ğŸ©· Plan de vizionat</option><option value="dropped">ğŸ”´ Dropped</option>
        </select>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:14}}>
          <div><label style={lbl}>Scor (1â€“10)</label><input type="number" inputMode="numeric" min={1} max={10} value={score} onChange={e=>setScore(e.target.value)} placeholder="â€”" style={inp}/></div>
          <div><label style={lbl}>Ep. Vizionate</label><input type="number" inputMode="numeric" min={0} max={anime.episodes||9999} value={eps} onChange={e=>setEps(e.target.value)} style={inp}/></div>
        </div>
        <label style={lbl}>Note</label>
        <input type="text" value={notes} onChange={e=>setNotes(e.target.value)} placeholder="OpÈ›ional..." style={{...inp,marginBottom:20}}/>
        <button onClick={()=>onSave({status,userScore:parseInt(score)||null,epsWatched:parseInt(eps)||0,notes})} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:3,textTransform:'uppercase',background:'var(--red)',color:'white',border:'none',padding:14,cursor:'pointer'}}>SALVEAZÄ‚</button>
      </div>
    </div>
  );
}

function DelConfirm({onConfirm,onClose}){
  const mob=useIsMobile();
  return(
    <div style={{position:'fixed',inset:0,zIndex:850,background:'rgba(0,0,0,0.9)',backdropFilter:'blur(5px)',display:'flex',alignItems:mob?'flex-end':'center',justifyContent:'center',padding:mob?0:24,animation:'fadeIn .2s'}} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={{background:'var(--mid)',border:'1px solid var(--border)',borderTop:'2px solid var(--red)',maxWidth:340,width:'100%',padding:28,textAlign:'center',animation:mob?'slideUp .3s':'scaleIn .2s',borderRadius:mob?'16px 16px 0 0':0,paddingBottom:'calc(env(safe-area-inset-bottom,0px) + 28px)'}}>
        <div style={{fontSize:28,marginBottom:14}}>âš ï¸</div>
        <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:20,letterSpacing:1,textTransform:'uppercase',color:'var(--white)',marginBottom:8}}>Confirmi È™tergerea?</div>
        <div style={{fontSize:13,color:'var(--grey2)',marginBottom:22}}>Nu poate fi anulatÄƒ</div>
        <div style={{display:'flex',gap:10,justifyContent:'center'}}>
          <button onClick={onClose} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:2,textTransform:'uppercase',background:'none',border:'1px solid var(--border)',color:'var(--grey2)',padding:'10px 22px',cursor:'pointer'}}>ANULEAZÄ‚</button>
          <button onClick={onConfirm} style={{fontFamily:'var(--fd)',fontWeight:800,fontSize:11,letterSpacing:2,textTransform:'uppercase',background:'var(--red)',color:'white',border:'none',padding:'10px 22px',cursor:'pointer'}}>È˜TERGE</button>
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MUSIC PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function MusicPanel({showToast}){
  const[tracks,setTracks]=useState(getMusic);
  const[title,setTitle]=useState('');
  const[artist,setArtist]=useState('');
  const[type,setType]=useState('mp3'); // mp3 | youtube | spotify
  const[link,setLink]=useState('');
  const[mp3Data,setMp3Data]=useState(null);
  const[mp3Name,setMp3Name]=useState('');
  const[loading,setLoading]=useState(false);
  const[delId,setDelId]=useState(null);
  const fileRef=useRef(null);
  const mob=useIsMobile();

  useEffect(()=>{saveMusic(tracks);},[tracks]);

  const onFile=e=>{
    const f=e.target.files[0];
    if(!f)return;
    if(!f.type.startsWith('audio/')){showToast('SelecteazÄƒ un fiÈ™ier audio!','err');return;}
    if(f.size>20*1024*1024){showToast('FiÈ™ier prea mare (max 20MB)','err');return;}
    setLoading(true);
    const reader=new FileReader();
    reader.onload=ev=>{setMp3Data(ev.target.result);setMp3Name(f.name.replace(/\.[^.]+$/,''));if(!title)setTitle(f.name.replace(/\.[^.]+$/,''));setLoading(false);};
    reader.readAsDataURL(f);
  };

  const extractYtId=url=>{
    const m=url.match(/(?:youtu\.be\/|youtube\.com\/(?:watch\?v=|embed\/|shorts\/))([a-zA-Z0-9_-]{11})/);
    return m?m[1]:null;
  };
  const extractSpotifyId=url=>{
    const m=url.match(/spotify\.com\/track\/([a-zA-Z0-9]+)/);
    return m?m[1]:null;
  };

  const addTrack=()=>{
    if(!title.trim()){showToast('Introdu un titlu!','err');return;}
    if(type==='mp3'&&!mp3Data){showToast('SelecteazÄƒ un fiÈ™ier MP3!','err');return;}
    if(type==='youtube'){
      const id=extractYtId(link);
      if(!id){showToast('Link YouTube invalid!','err');return;}
      const t={id:Date.now(),title:title.trim(),artist:artist.trim(),type:'youtube',ytId:id,addedAt:Date.now()};
      setTracks(p=>[...p,t]);showToast(`âœ“ "${t.title}" adÄƒugat!`,'ok');
      setTitle('');setArtist('');setLink('');return;
    }
    if(type==='spotify'){
      const id=extractSpotifyId(link);
      if(!id){showToast('Link Spotify invalid! (necesitÄƒ link de tip .../track/...)','err');return;}
      const t={id:Date.now(),title:title.trim(),artist:artist.trim(),type:'spotify',spotifyId:id,addedAt:Date.now()};
      setTracks(p=>[...p,t]);showToast(`âœ“ "${t.title}" adÄƒugat!`,'ok');
      setTitle('');setArtist('');setLink('');return;
    }
    // mp3
    const t={id:Date.now(),title:title.trim(),artist:artist.trim(),type:'mp3',src:mp3Data,addedAt:Date.now()};
    setTracks(p=>[...p,t]);showToast(`âœ“ "${t.title}" adÄƒugat!`,'ok');
    setTitle('');setArtist('');setMp3Data(null);setMp3Name('');setLink('');
    if(fileRef.current)fileRef.current.value='';
  };

  const removeTrack=id=>{setTracks(p=>p.filter(t=>t.id!==id));setDelId(null);showToast('Track È™ters','ok');};

  const inpS={width:'100%',background:'rgba(0,0,0,0.55)',border:'1px solid rgba(255,255,255,0.07)',borderBottom:'2px solid rgba(255,255,255,0.12)',padding:'11px 13px',color:'#fff',fontSize:14,outline:'none',WebkitAppearance:'none',marginBottom:0};
  const lblS={fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:3,textTransform:'uppercase',color:'var(--grey2)',marginBottom:7,display:'block'};

  const typeColors={'mp3':'#c9a84c','youtube':'#ff4444','spotify':'#1db954'};
  const typeIcon={'mp3':'ğŸµ','youtube':'â–¶','spotify':'â™«'};

  return(
    <div style={{padding:mob?'20px 16px 80px':40}}>
      <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?20:24,letterSpacing:1,textTransform:'uppercase',color:'#fff',marginBottom:24,paddingBottom:14,borderBottom:'1px solid rgba(255,255,255,0.07)',display:'flex',alignItems:'center',gap:10}}>
        <span style={{color:'var(--gold)'}}>â™ª</span> MuzicÄƒ
      </div>

      {/* Type selector */}
      <div style={{display:'flex',gap:2,marginBottom:20,background:'rgba(255,255,255,0.03)',padding:3,borderRadius:2}}>
        {[['mp3','MP3'],['youtube','YouTube'],['spotify','Spotify']].map(([k,l])=>(
          <button key={k} onClick={()=>{setType(k);setLink('');}} style={{flex:1,fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:2,textTransform:'uppercase',padding:'9px 0',background:type===k?typeColors[k]:'transparent',color:type===k?'#000':'rgba(255,255,255,0.35)',border:'none',cursor:'pointer',transition:'all .2s',borderRadius:1}}>{typeIcon[k]} {l}</button>
        ))}
      </div>

      {/* Title + Artist */}
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:14}}>
        <div>
          <label style={lblS}>Titlu *</label>
          <input value={title} onChange={e=>setTitle(e.target.value)} placeholder="Numele melodiei" style={inpS}/>
        </div>
        <div>
          <label style={lblS}>Artist</label>
          <input value={artist} onChange={e=>setArtist(e.target.value)} placeholder="OpÈ›ional" style={inpS}/>
        </div>
      </div>

      {/* MP3 upload */}
      {type==='mp3'&&(
        <div style={{marginBottom:14}}>
          <label style={lblS}>FiÈ™ier Audio (max 20MB)</label>
          <div onClick={()=>fileRef.current?.click()} style={{border:'2px dashed rgba(201,168,76,0.3)',background:mp3Data?'rgba(201,168,76,0.05)':'rgba(255,255,255,0.01)',padding:'18px 16px',cursor:'pointer',textAlign:'center',transition:'all .2s'}} onMouseEnter={e=>e.currentTarget.style.borderColor='rgba(201,168,76,0.55)'} onMouseLeave={e=>e.currentTarget.style.borderColor='rgba(201,168,76,0.3)'}>
            {loading?<span style={{color:'var(--grey2)',fontSize:12}}>Se Ã®ncarcÄƒ...</span>
            :mp3Data?<span style={{color:'var(--gold)',fontFamily:'var(--fd)',fontWeight:700,fontSize:13}}>ğŸµ {mp3Name}</span>
            :<span style={{color:'var(--grey2)',fontSize:12}}>ApasÄƒ sau trage fiÈ™ierul MP3/AAC/OGG</span>}
          </div>
          <input ref={fileRef} type="file" accept="audio/*" onChange={onFile} style={{display:'none'}}/>
        </div>
      )}

      {/* YouTube link */}
      {type==='youtube'&&(
        <div style={{marginBottom:14}}>
          <label style={lblS}>Link YouTube</label>
          <input value={link} onChange={e=>setLink(e.target.value)} placeholder="https://youtube.com/watch?v=..." style={inpS}/>
          <div style={{fontSize:11,color:'rgba(255,255,255,0.2)',marginTop:6}}>AcceptÄƒ linkuri youtube.com È™i youtu.be</div>
        </div>
      )}

      {/* Spotify link */}
      {type==='spotify'&&(
        <div style={{marginBottom:14}}>
          <label style={lblS}>Link Spotify</label>
          <input value={link} onChange={e=>setLink(e.target.value)} placeholder="https://open.spotify.com/track/..." style={inpS}/>
          <div style={{fontSize:11,color:'rgba(255,255,255,0.2)',marginTop:6}}>NecesitÄƒ link de tip /track/ â€” se va deschide Ã®n Spotify</div>
        </div>
      )}

      <button onClick={addTrack} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:4,textTransform:'uppercase',background:`${typeColors[type]}`,color:'#000',border:'none',padding:14,cursor:'pointer',marginBottom:28,marginTop:4}}>
        + ADAUGÄ‚ MELODIE
      </button>

      {/* Track list */}
      {tracks.length>0&&(
        <>
        <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:3,textTransform:'uppercase',color:'var(--grey2)',marginBottom:12}}>{tracks.length} melodii Ã®n playlist</div>
        <div style={{display:'flex',flexDirection:'column',gap:2}}>
          {tracks.map((t,i)=>(
            <div key={t.id} style={{display:'flex',gap:10,alignItems:'center',padding:'10px 12px',background:'rgba(255,255,255,0.02)',border:'1px solid rgba(255,255,255,0.05)'}}>
              <span style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:11,color:'rgba(255,255,255,0.15)',width:20,flexShrink:0,textAlign:'right'}}>{String(i+1).padStart(2,'0')}</span>
              <span style={{fontSize:14,flexShrink:0}}>{typeIcon[t.type]}</span>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:13,color:'#fff',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{t.title}</div>
                {t.artist&&<div style={{fontSize:11,color:'var(--grey2)',marginTop:1}}>{t.artist}</div>}
              </div>
              <span style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:8,letterSpacing:1.5,textTransform:'uppercase',padding:'2px 6px',border:`1px solid ${typeColors[t.type]}44`,color:typeColors[t.type],flexShrink:0}}>{t.type}</span>
              {delId===t.id?(
                <div style={{display:'flex',gap:6,flexShrink:0}}>
                  <button onClick={()=>removeTrack(t.id)} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,background:'rgba(255,68,68,0.15)',border:'1px solid rgba(255,68,68,0.4)',color:'#ff6666',padding:'4px 8px',cursor:'pointer'}}>DA</button>
                  <button onClick={()=>setDelId(null)} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,background:'none',border:'1px solid rgba(255,255,255,0.1)',color:'var(--grey2)',padding:'4px 8px',cursor:'pointer'}}>NU</button>
                </div>
              ):(
                <button onClick={()=>setDelId(t.id)} style={{background:'none',border:'1px solid rgba(255,68,68,0.15)',color:'rgba(255,68,68,0.4)',padding:'4px 8px',cursor:'pointer',fontSize:12,flexShrink:0,transition:'all .2s'}} onMouseEnter={e=>{e.currentTarget.style.color='#ff4444';e.currentTarget.style.borderColor='rgba(255,68,68,0.4)';}} onMouseLeave={e=>{e.currentTarget.style.color='rgba(255,68,68,0.4)';e.currentTarget.style.borderColor='rgba(255,68,68,0.15)';}}>âœ•</button>
              )}
            </div>
          ))}
        </div>
        </>
      )}

      {tracks.length===0&&(
        <div style={{textAlign:'center',padding:'40px 20px',color:'rgba(255,255,255,0.1)'}}>
          <div style={{fontSize:36,marginBottom:10}}>ğŸµ</div>
          <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:18,letterSpacing:1,textTransform:'uppercase'}}>Nicio melodie</div>
        </div>
      )}
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   XML IMPORT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function XmlImportModal({onImport,onClose,showToast}){
  const[state,setState]=useState('idle'); // idle | parsing | preview | done | error
  const[errMsg,setErrMsg]=useState('');
  const[parsed,setParsed]=useState([]);
  const[sel,setSel]=useState(new Set());
  const[fileName,setFileName]=useState('');
  const fileRef=useRef(null);
  const mob=useIsMobile();

  useEffect(()=>{
    const h=e=>{if(e.key==='Escape')onClose();};
    window.addEventListener('keydown',h);return()=>window.removeEventListener('keydown',h);
  },[onClose]);

  /* Parse XML â†’ array of anime objects */
  function parseXml(xmlText){
    const parser=new DOMParser();
    const doc=parser.parseFromString(xmlText,'application/xml');
    const parseErr=doc.querySelector('parsererror');
    if(parseErr) throw new Error('XML invalid sau corupt');

    const items=[];

    /* Format 1: MAL export XML â€” <anime> nodes inside <myanimelist> */
    const malNodes=[...doc.querySelectorAll('myanimelist anime,anime')];
    if(malNodes.length>0){
      for(const node of malNodes){
        const g=t=>node.querySelector(t)?.textContent?.trim()||'';
        const malId=parseInt(g('series_animedb_id'));
        if(!malId) continue;
        const statusMap={'Watching':'watching','Completed':'completed','Plan to Watch':'plan_to_watch','Dropped':'dropped','On-Hold':'plan_to_watch'};
        items.push({
          mal_id:malId,
          title:g('series_title')||g('series_title'),
          title_english:g('series_title_english')||null,
          image:'',image_sm:'',
          score:parseFloat(g('series_mean_score'))||null,
          episodes:parseInt(g('series_episodes'))||null,
          year:null,genres:[],synopsis:'',type:g('series_type')||'',
          status:statusMap[g('my_status')]||'plan_to_watch',
          userScore:parseInt(g('my_score'))||null,
          epsWatched:parseInt(g('my_watched_episodes'))||0,
          notes:g('my_comments')||'',
          addedAt:Date.now(),
        });
      }
    }

    /* Format 2: custom HighEdits export â€” <library><entry> nodes */
    if(items.length===0){
      const entries=[...doc.querySelectorAll('library entry, entries entry, collection entry, entry')];
      for(const node of entries){
        const g=t=>node.querySelector(t)?.textContent?.trim()||'';
        const malId=parseInt(g('mal_id')||g('malId')||g('id'));
        if(!malId) continue;
        items.push({
          mal_id:malId,
          title:g('title'),
          title_english:g('title_english')||g('titleEnglish')||null,
          image:g('image')||'',image_sm:g('image_sm')||'',
          score:parseFloat(g('score'))||null,
          episodes:parseInt(g('episodes'))||null,
          year:parseInt(g('year'))||null,
          genres:g('genres')?g('genres').split(',').map(s=>s.trim()).filter(Boolean):[],
          synopsis:g('synopsis')||'',
          type:g('type')||'',
          status:g('status')||'plan_to_watch',
          userScore:parseInt(g('userScore')||g('user_score'))||null,
          epsWatched:parseInt(g('epsWatched')||g('eps_watched'))||0,
          notes:g('notes')||'',
          addedAt:Date.now(),
        });
      }
    }

    if(items.length===0) throw new Error('Niciun anime gÄƒsit Ã®n XML. VerificÄƒ formatul fiÈ™ierului.');
    return items;
  }

  const[fetchProgress,setFetchProgress]=useState(0);
  const[fetchStatus,setFetchStatus]=useState(''); // current anime name being fetched

  const handleFile=e=>{
    const file=e.target.files?.[0];
    if(!file) return;
    setFileName(file.name);
    setState('parsing');
    setErrMsg('');
    const reader=new FileReader();
    reader.onload=async ev=>{
      try{
        const items=parseXml(ev.target.result);
        setState('fetching');
        setFetchProgress(0);
        setFetchStatus('');
        const enriched=[...items];

        /* Fetch a single anime with up to `maxRetries` retries */
        async function fetchAnime(malId, retries=4){
          for(let attempt=0;attempt<=retries;attempt++){
            try{
              const r=await fetch(`${JIKAN}/anime/${malId}`);
              if(r.status===429){
                // rate limited â€” wait longer and retry
                await new Promise(res=>setTimeout(res,1500+(attempt*1000)));
                continue;
              }
              if(!r.ok) throw new Error(`HTTP ${r.status}`);
              const d=await r.json();
              return d?.data||null;
            }catch(err){
              if(attempt<retries){
                await new Promise(res=>setTimeout(res,800+(attempt*600)));
              }
            }
          }
          return null;
        }

        /* Sequential fetch â€” one at a time, 700ms between each */
        for(let i=0;i<enriched.length;i++){
          const a=enriched[i];
          setFetchStatus(a.title||`#${a.mal_id}`);
          setFetchProgress(Math.round((i/enriched.length)*100));

          if(!a.image){
            const data=await fetchAnime(a.mal_id);
            if(data){
              enriched[i].image=data.images?.jpg?.large_image_url||data.images?.jpg?.image_url||'';
              enriched[i].image_sm=data.images?.jpg?.small_image_url||enriched[i].image||'';
              enriched[i].title_english=enriched[i].title_english||data.title_english||null;
              enriched[i].score=enriched[i].score||data.score||null;
              enriched[i].episodes=enriched[i].episodes||data.episodes||null;
              enriched[i].year=enriched[i].year||data.aired?.prop?.from?.year||null;
              enriched[i].genres=enriched[i].genres?.length?enriched[i].genres:(data.genres||[]).map(g=>g.name);
              enriched[i].synopsis=enriched[i].synopsis||data.synopsis||'';
              enriched[i].type=enriched[i].type||data.type||'';
            }
          }

          // 700ms between each request â€” safe for Jikan's 3 req/sec limit
          if(i<enriched.length-1) await new Promise(res=>setTimeout(res,700));
        }

        setFetchProgress(100);
        setFetchStatus('');
        setParsed(enriched);
        setSel(new Set(enriched.map(a=>a.mal_id)));
        setState('preview');
      }catch(err){
        setErrMsg(err.message);
        setState('error');
      }
    };
    reader.onerror=()=>{setErrMsg('Eroare la citirea fiÈ™ierului.');setState('error');};
    reader.readAsText(file);
    e.target.value='';
  };

  const toggleAll=()=>{
    if(sel.size===parsed.length) setSel(new Set());
    else setSel(new Set(parsed.map(a=>a.mal_id)));
  };
  const toggleOne=id=>setSel(prev=>{const n=new Set(prev);n.has(id)?n.delete(id):n.add(id);return n;});

  const doImport=()=>{
    const toImport=parsed.filter(a=>sel.has(a.mal_id));
    onImport(toImport);
    showToast(`âœ“ ${toImport.length} anime importate din XML!`,'ok');
    setState('done');
    setTimeout(onClose,1400);
  };

  const STATUS_COLORS={watching:'#7c8fff',completed:'#4ecdc4',plan_to_watch:'#ff6b9d',dropped:'#ff4444'};

  return(
    <div style={{
      position:'fixed',inset:0,zIndex:900,
      background:'rgba(0,0,0,0.88)',backdropFilter:'blur(7px)',
      display:'flex',alignItems:mob?'flex-end':'center',justifyContent:'center',
      padding:mob?0:24,animation:'fadeIn .2s ease',
    }} onClick={e=>e.target===e.currentTarget&&onClose()}>
      <div style={{
        background:'var(--dark)',border:mob?'none':'1px solid var(--border)',
        borderTop:'2px solid var(--green)',
        width:'100%',maxWidth:mob?'100%':560,
        maxHeight:mob?'92vh':'88vh',overflowY:'auto',position:'relative',
        borderRadius:mob?'18px 18px 0 0':0,
        animation:mob?'slideUp .3s ease':'scaleIn .25s ease',
        paddingBottom:'env(safe-area-inset-bottom,0px)',
      }}>
        {/* Header */}
        <div style={{padding:mob?'20px 20px 0':'28px 28px 0',display:'flex',alignItems:'flex-start',justifyContent:'space-between',gap:12}}>
          <div>
            <h2 style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?20:26,letterSpacing:1,textTransform:'uppercase',color:'var(--white)',display:'flex',alignItems:'center',gap:8}}>
              <span style={{color:'var(--green)'}}>ğŸ“„</span> Import XML
            </h2>
            <p style={{fontSize:12,color:'var(--grey2)',marginTop:3}}>SelecteazÄƒ un fiÈ™ier .xml â€” export MAL sau format HighEdits</p>
          </div>
          <button onClick={onClose} style={{background:'rgba(255,255,255,0.06)',border:'1px solid var(--border)',color:'white',width:30,height:30,fontSize:15,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,borderRadius:6}}>âœ•</button>
        </div>

        <div style={{padding:mob?'20px':'28px'}}>

          {/* IDLE / ERROR: file picker drop zone */}
          {(state==='idle'||state==='error')&&(
            <div>
              <input ref={fileRef} type="file" accept=".xml,application/xml,text/xml" style={{display:'none'}} onChange={handleFile}/>
              <div
                onClick={()=>fileRef.current?.click()}
                style={{
                  border:'2px dashed rgba(78,205,196,0.3)',
                  borderRadius:8,
                  padding:mob?'32px 20px':'44px 32px',
                  textAlign:'center',
                  cursor:'pointer',
                  background:'rgba(78,205,196,0.04)',
                  transition:'all .2s',
                }}
                onMouseEnter={e=>{e.currentTarget.style.borderColor='rgba(78,205,196,0.6)';e.currentTarget.style.background='rgba(78,205,196,0.08)';}}
                onMouseLeave={e=>{e.currentTarget.style.borderColor='rgba(78,205,196,0.3)';e.currentTarget.style.background='rgba(78,205,196,0.04)';}}
              >
                <div style={{fontSize:40,marginBottom:12,opacity:0.7}}>ğŸ“‚</div>
                <div style={{fontFamily:'var(--fd)',fontWeight:800,fontSize:mob?14:16,letterSpacing:2,textTransform:'uppercase',color:'var(--green)',marginBottom:6}}>
                  Click pentru a selecta fiÈ™ierul
                </div>
                <div style={{fontSize:12,color:'var(--grey2)'}}>AcceptÄƒ: .xml (export MAL, HighEdits)</div>
              </div>
              {state==='error'&&(
                <div style={{marginTop:14,padding:'12px 14px',background:'rgba(255,68,68,0.08)',border:'1px solid rgba(255,68,68,0.2)',borderLeft:'3px solid var(--red)'}}>
                  <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:1,color:'var(--red)',marginBottom:3}}>âœ— Eroare</div>
                  <div style={{fontSize:13,color:'rgba(255,100,100,0.8)'}}>{errMsg}</div>
                </div>
              )}
            </div>
          )}

          {/* PARSING: spinner */}
          {state==='parsing'&&(
            <div style={{textAlign:'center',padding:'48px 0',display:'flex',flexDirection:'column',alignItems:'center',gap:14}}>
              <span style={{display:'inline-block',width:32,height:32,border:'2px solid rgba(255,255,255,0.07)',borderTopColor:'var(--green)',borderRadius:'50%',animation:'spin 0.7s linear infinite'}}/>
              <div style={{fontFamily:'var(--fd)',fontSize:11,letterSpacing:3,textTransform:'uppercase',color:'var(--grey2)'}}>Se proceseazÄƒ {fileName}...</div>
            </div>
          )}

          {/* FETCHING IMAGES: progress */}
          {state==='fetching'&&(
            <div style={{textAlign:'center',padding:'40px 0',display:'flex',flexDirection:'column',alignItems:'center',gap:14}}>
              <span style={{display:'inline-block',width:32,height:32,border:'2px solid rgba(255,255,255,0.07)',borderTopColor:'var(--green)',borderRadius:'50%',animation:'spin 0.7s linear infinite'}}/>
              <div>
                <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:28,color:'var(--green)',lineHeight:1,marginBottom:4}}>
                  {fetchProgress}%
                </div>
                <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:2,textTransform:'uppercase',color:'rgba(255,255,255,0.4)',marginBottom:6}}>
                  Se descarcÄƒ pozele
                </div>
                {fetchStatus&&(
                  <div style={{fontSize:12,color:'var(--grey2)',maxWidth:280,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>
                    â†³ {fetchStatus}
                  </div>
                )}
              </div>
              <div style={{width:'100%',maxWidth:320,height:3,background:'rgba(255,255,255,0.07)',borderRadius:2,overflow:'hidden'}}>
                <div style={{height:'100%',width:`${fetchProgress}%`,background:'var(--green)',borderRadius:2,transition:'width .6s ease'}}/>
              </div>
              <div style={{fontSize:11,color:'rgba(255,255,255,0.15)',marginTop:2}}>
                CÃ¢te unul pe rÃ¢nd â€” nu Ã®nchide fereastra
              </div>
            </div>
          )}

          {/* PREVIEW: list of parsed anime */}
          {state==='preview'&&(
            <div>
              {/* Summary bar */}
              <div style={{display:'flex',alignItems:'center',justifyContent:'space-between',marginBottom:14,padding:'10px 14px',background:'rgba(78,205,196,0.08)',border:'1px solid rgba(78,205,196,0.18)',borderLeft:'3px solid var(--green)'}}>
                <div>
                  <span style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:22,color:'var(--green)'}}>{parsed.length}</span>
                  <span style={{fontFamily:'var(--fd)',fontSize:11,letterSpacing:2,textTransform:'uppercase',color:'var(--grey2)',marginLeft:8}}>anime gÄƒsite Ã®n {fileName}</span>
                </div>
                <button onClick={toggleAll} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:10,letterSpacing:2,textTransform:'uppercase',background:'none',border:'1px solid var(--border)',color:'var(--grey2)',padding:'5px 10px',cursor:'pointer',transition:'all .15s'}}
                  onMouseEnter={e=>e.currentTarget.style.color='white'} onMouseLeave={e=>e.currentTarget.style.color='var(--grey2)'}>
                  {sel.size===parsed.length?'DeselecteazÄƒ tot':'SelecteazÄƒ tot'}
                </button>
              </div>

              {/* List */}
              <div style={{maxHeight:mob?'38vh':'40vh',overflowY:'auto',display:'flex',flexDirection:'column',gap:2,marginBottom:16}}>
                {parsed.map(a=>{
                  const checked=sel.has(a.mal_id);
                  const sc=STATUS_COLORS[a.status]||'#888';
                  return(
                    <div key={a.mal_id} onClick={()=>toggleOne(a.mal_id)} style={{
                      display:'flex',alignItems:'center',gap:10,padding:'8px 12px',
                      background:checked?'rgba(78,205,196,0.06)':'transparent',
                      border:`1px solid ${checked?'rgba(78,205,196,0.15)':'var(--border)'}`,
                      cursor:'pointer',transition:'all .15s',borderRadius:4,
                    }}
                    onMouseEnter={e=>e.currentTarget.style.background=checked?'rgba(78,205,196,0.1)':'rgba(255,255,255,0.03)'}
                    onMouseLeave={e=>e.currentTarget.style.background=checked?'rgba(78,205,196,0.06)':'transparent'}>
                      {/* Checkbox */}
                      <div style={{
                        width:16,height:16,borderRadius:3,flexShrink:0,
                        border:`2px solid ${checked?'var(--green)':'rgba(255,255,255,0.2)'}`,
                        background:checked?'var(--green)':'transparent',
                        display:'flex',alignItems:'center',justifyContent:'center',
                        transition:'all .15s',
                      }}>
                        {checked&&<span style={{fontSize:9,color:'#000',fontWeight:900,lineHeight:1}}>âœ“</span>}
                      </div>
                      {/* Thumbnail */}
                      <div style={{width:32,height:46,flexShrink:0,background:'#111',borderRadius:3,overflow:'hidden'}}>
                        {a.image_sm||a.image
                          ?<img src={a.image_sm||a.image} alt="" style={{width:'100%',height:'100%',objectFit:'cover',display:'block'}}/>
                          :<div style={{width:'100%',height:'100%',display:'flex',alignItems:'center',justifyContent:'center',fontSize:12,color:'rgba(255,255,255,0.15)'}}>?</div>
                        }
                      </div>
                      {/* Info */}
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:13,color:'rgba(255,255,255,0.88)',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}}>{a.title}</div>
                        <div style={{display:'flex',gap:8,marginTop:2,alignItems:'center'}}>
                          <span style={{fontFamily:'var(--fd)',fontSize:9,letterSpacing:1,textTransform:'uppercase',color:sc,border:`1px solid ${sc}33`,padding:'1px 5px'}}>{a.status?.replace('_',' ')}</span>
                          {a.epsWatched>0&&<span style={{fontFamily:'var(--fd)',fontSize:10,color:'var(--grey2)'}}>ep {a.epsWatched}{a.episodes?'/'+a.episodes:''}</span>}
                          {a.userScore>0&&<span style={{fontFamily:'var(--fd)',fontSize:10,color:'var(--gold)'}}>â˜… {a.userScore}</span>}
                        </div>
                      </div>
                      <span style={{fontFamily:'var(--fd)',fontSize:10,color:'rgba(255,255,255,0.2)',flexShrink:0}}>#{a.mal_id}</span>
                    </div>
                  );
                })}
              </div>

              {/* Import button */}
              <button onClick={doImport} disabled={sel.size===0} style={{
                width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:3,
                textTransform:'uppercase',
                background:sel.size===0?'rgba(78,205,196,0.12)':'var(--green)',
                color:sel.size===0?'rgba(78,205,196,0.4)':'#000',
                border:'none',padding:14,cursor:sel.size===0?'not-allowed':'pointer',
                display:'flex',alignItems:'center',justifyContent:'center',gap:8,
                transition:'opacity .2s',
              }}>
                ğŸ“¥ IMPORTÄ‚ {sel.size} ANIME SELECTATE
              </button>
            </div>
          )}

          {/* DONE */}
          {state==='done'&&(
            <div style={{textAlign:'center',padding:'48px 0'}}>
              <div style={{fontSize:48,marginBottom:12}}>âœ…</div>
              <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:22,letterSpacing:1,textTransform:'uppercase',color:'var(--green)'}}>Import reuÈ™it!</div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADMIN PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function AdminPanel({onLogout}){
  const[library,setLibrary]=useState(getLib);
  const[tab,setTab]=useState('add');
  const[searchQ,setSearchQ]=useState('');
  const[results,setResults]=useState([]);
  const[srLoad,setSrLoad]=useState(false);
  const[selAnime,setSelAnime]=useState(null);
  const[status,setStatus]=useState('watching');
  const[score,setScore]=useState('');
  const[eps,setEps]=useState('');
  const[notes,setNotes]=useState('');
  const[listFilter,setListFilter]=useState('all');
  const[editItem,setEditItem]=useState(null);
  const[delId,setDelId]=useState(null);
  const[showImport,setShowImport]=useState(false);
  const[showXmlImport,setShowXmlImport]=useState(false);
  const[showCPass,setShowCPass]=useState(false);
  const[settingsOpen,setSettingsOpen]=useState(false);
  const[showMusicPanel,setShowMusicPanel]=useState(false);
  const[toast,showToast]=useToast();
  const srTimer=useRef(null);const wrapRef=useRef(null);
  const mob=useIsMobile();

  useEffect(()=>{saveLib(library);},[library]);

  useEffect(()=>{
    const h=e=>{if(wrapRef.current&&!wrapRef.current.contains(e.target))setResults([]);};
    document.addEventListener('mousedown',h);document.addEventListener('touchstart',h,{passive:true});
    return()=>{document.removeEventListener('mousedown',h);document.removeEventListener('touchstart',h);};
  },[]);

  useEffect(()=>{
    clearTimeout(srTimer.current);
    if(!searchQ.trim()){setResults([]);return;}
    srTimer.current=setTimeout(async()=>{setSrLoad(true);const d=await jikan(`/anime?q=${encodeURIComponent(searchQ)}&limit=8&sfw=true`);setResults(d?.data?.map(mapJikanAnime)||[]);setSrLoad(false);},420);
  },[searchQ]);

  const selectAnime=a=>{setSelAnime(a);setResults([]);setSearchQ(a.title);setEps(0);setScore('');setNotes('');};
  const addAnime=()=>{
    if(!selAnime){showToast('SelecteazÄƒ un anime!','err');return;}
    if(library.some(x=>x.mal_id===selAnime.mal_id)){showToast('Deja Ã®n colecÈ›ie!','err');return;}
    const entry={...selAnime,status,userScore:parseInt(score)||null,epsWatched:parseInt(eps)||0,notes,addedAt:Date.now()};
    setLibrary(p=>[entry,...p]);setSelAnime(null);setSearchQ('');setScore('');setEps('');setNotes('');setStatus('watching');
    showToast(`âœ“ "${entry.title_english||entry.title}" adÄƒugat!`,'ok');
    if(mob) setTab('list');
  };
  const removeAnime=id=>{setLibrary(p=>p.filter(a=>a.mal_id!==id));setDelId(null);showToast('Eliminat','ok');};
  const saveEdit=(id,ch)=>{setLibrary(p=>p.map(a=>a.mal_id===id?{...a,...ch}:a));setEditItem(null);showToast('Modificat!','ok');};
  const handleImport=items=>{
    setLibrary(prev=>{const ex=new Set(prev.map(a=>a.mal_id));const nw=items.filter(a=>!ex.has(a.mal_id));return[...nw,...prev];});
  };
  const deleteAll=()=>{if(window.confirm('È˜tergi TOATÄ‚ colecÈ›ia?')){setLibrary([]);showToast('ColecÈ›ie È™tearsÄƒ','ok');setSettingsOpen(false);}};

  const filtered=useMemo(()=>listFilter==='all'?library:library.filter(a=>a.status===listFilter),[library,listFilter]);
  const sc={all:library.length,watching:library.filter(a=>a.status==='watching').length,completed:library.filter(a=>a.status==='completed').length,plan_to_watch:library.filter(a=>a.status==='plan_to_watch').length,dropped:library.filter(a=>a.status==='dropped').length};

  const FormPanel=()=>(
    <div style={{padding:mob?'20px 16px 80px':40}}>
      <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?20:24,letterSpacing:1,textTransform:'uppercase',color:'var(--white)',marginBottom:20,paddingBottom:14,borderBottom:'1px solid var(--border)',display:'flex',alignItems:'center',gap:10}}><span style={{color:'var(--red)'}}>ï¼‹</span>AdaugÄƒ Anime</div>

      {/* MAL Import CTA */}
      <button onClick={()=>setShowImport(true)} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:2,textTransform:'uppercase',background:'rgba(74,158,255,0.1)',color:'var(--blue)',border:'1px solid rgba(74,158,255,0.28)',borderLeft:'3px solid var(--blue)',padding:'13px 16px',cursor:'pointer',display:'flex',alignItems:'center',gap:10,marginBottom:10,transition:'background .2s',textAlign:'left'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(74,158,255,0.17)'} onMouseLeave={e=>e.currentTarget.style.background='rgba(74,158,255,0.1)'}>
        <span style={{fontSize:20,flexShrink:0}}>â†“</span>
        <div><div>Import din MyAnimeList</div><div style={{fontSize:10,fontWeight:600,color:'rgba(74,158,255,0.6)',letterSpacing:.5,marginTop:2,textTransform:'none'}}>ImportÄƒ lista unui cont MAL prin username</div></div>
        <span style={{marginLeft:'auto',opacity:.4}}>â†’</span>
      </button>

      {/* XML Import CTA */}
      <button onClick={()=>setShowXmlImport(true)} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:2,textTransform:'uppercase',background:'rgba(78,205,196,0.08)',color:'var(--green)',border:'1px solid rgba(78,205,196,0.22)',borderLeft:'3px solid var(--green)',padding:'13px 16px',cursor:'pointer',display:'flex',alignItems:'center',gap:10,marginBottom:18,transition:'background .2s',textAlign:'left'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(78,205,196,0.15)'} onMouseLeave={e=>e.currentTarget.style.background='rgba(78,205,196,0.08)'}>
        <span style={{fontSize:20,flexShrink:0}}>ğŸ“„</span>
        <div><div>Import din fiÈ™ier XML</div><div style={{fontSize:10,fontWeight:600,color:'rgba(78,205,196,0.55)',letterSpacing:.5,marginTop:2,textTransform:'none'}}>SelecteazÄƒ un fiÈ™ier .xml de pe dispozitiv</div></div>
        <span style={{marginLeft:'auto',opacity:.4}}>â†’</span>
      </button>

      <div style={{display:'flex',alignItems:'center',gap:12,marginBottom:18}}>
        <div style={{flex:1,height:1,background:'var(--border)'}}/>
        <span style={{fontFamily:'var(--fd)',fontSize:10,letterSpacing:3,color:'var(--grey)',textTransform:'uppercase'}}>sau cautÄƒ manual</span>
        <div style={{flex:1,height:1,background:'var(--border)'}}/>
      </div>

      <label style={lbl}>CautÄƒ anime (Jikan API)</label>
      <div ref={wrapRef} style={{position:'relative',marginBottom:18}}>
        <input value={searchQ} onChange={e=>setSearchQ(e.target.value)} placeholder="TasteazÄƒ titlul..." style={{...inp}} onFocus={e=>e.target.style.borderBottomColor='var(--red)'} onBlur={e=>e.target.style.borderBottomColor='rgba(255,255,255,0.12)'}/>
        <SearchDrop results={results} loading={srLoad} onSelect={selectAnime}/>
      </div>

      {selAnime&&(
        <div style={{display:'flex',gap:12,marginBottom:18,background:'rgba(0,0,0,0.5)',border:'1px solid var(--border)',borderLeft:'3px solid var(--red)',padding:12,alignItems:'flex-start',animation:'fadeUp .2s'}}>
          <img src={selAnime.image_sm||selAnime.image} style={{width:44,height:62,objectFit:'cover',flexShrink:0}} alt=""/>
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontFamily:'var(--fd)',fontWeight:800,fontSize:15,lineHeight:1.2,color:'var(--white)',marginBottom:3}}>{selAnime.title_english||selAnime.title}</div>
            <div style={{fontSize:11,color:'var(--grey2)',lineHeight:1.5}}>{selAnime.type} â€¢ â˜… {selAnime.score||'N/A'} â€¢ {selAnime.episodes||'?'} ep</div>
            <div style={{display:'flex',gap:4,flexWrap:'wrap',marginTop:4}}>{(selAnime.genres||[]).slice(0,3).map(g=><span key={g} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:9,letterSpacing:1,textTransform:'uppercase',padding:'2px 7px',border:'1px solid rgba(255,255,255,0.1)',color:'rgba(255,255,255,0.4)'}}>{g}</span>)}</div>
          </div>
          <button onClick={()=>{setSelAnime(null);setSearchQ('');}} style={{background:'none',border:'none',color:'var(--grey2)',fontSize:18,cursor:'pointer',flexShrink:0}}>âœ•</button>
        </div>
      )}

      <label style={lbl}>Status</label>
      <select value={status} onChange={e=>setStatus(e.target.value)} style={{...inp,marginBottom:14}}>
        <option value="watching">ğŸŸ£ UrmÄƒresc</option><option value="completed">ğŸ”µ Terminat</option><option value="plan_to_watch">ğŸ©· Plan de vizionat</option><option value="dropped">ğŸ”´ Dropped</option>
      </select>
      <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12,marginBottom:14}}>
        <div><label style={lbl}>Scor (1â€“10)</label><input type="number" inputMode="numeric" min={1} max={10} value={score} onChange={e=>setScore(e.target.value)} placeholder="â€”" style={inp}/></div>
        <div><label style={lbl}>Ep. Vizionate</label><input type="number" inputMode="numeric" min={0} value={eps} onChange={e=>setEps(e.target.value)} placeholder="0" style={inp}/></div>
      </div>
      <label style={lbl}>Note personale</label>
      <input type="text" value={notes} onChange={e=>setNotes(e.target.value)} placeholder="OpÈ›ional..." style={{...inp,marginBottom:22}}/>
      <button onClick={addAnime} style={{width:'100%',fontFamily:'var(--fd)',fontWeight:800,fontSize:12,letterSpacing:4,textTransform:'uppercase',background:'var(--red)',color:'white',border:'none',padding:15,cursor:'pointer',opacity:selAnime?1:0.4,transition:'opacity .2s'}}>ADAUGÄ‚ ÃN COLECÈšIE</button>
    </div>
  );

  const ListPanel=()=>(
    <div style={{padding:mob?'20px 0 80px':40}}>
      <div style={{padding:mob?'0 16px 14px':'0 0 14px',display:'flex',alignItems:'baseline',gap:10,paddingBottom:14,borderBottom:'1px solid var(--border)'}}>
        <h2 style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?20:28,letterSpacing:-1,textTransform:'uppercase',color:'var(--white)'}}>COLECÈšIE</h2>
        <span style={{fontFamily:'var(--fd)',fontSize:13,color:'var(--grey2)'}}>{library.length} titluri</span>
      </div>
      <div style={{display:'flex',overflowX:'auto',borderBottom:'1px solid var(--border)',scrollbarWidth:'none'}}>
        {[['all',`Toate(${sc.all})`],['watching',`ğŸŸ£${sc.watching}`],['completed',`ğŸ”µ${sc.completed}`],['plan_to_watch',`ğŸ©·${sc.plan_to_watch}`],['dropped',`ğŸ”´${sc.dropped}`]].map(([k,l])=>(
          <button key={k} onClick={()=>setListFilter(k)} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:mob?12:11,letterSpacing:mob?0:2,textTransform:'uppercase',padding:mob?'12px 12px':'13px 15px',background:'none',border:'none',borderBottom:listFilter===k?'2px solid var(--red)':'2px solid transparent',color:listFilter===k?'white':'rgba(255,255,255,0.32)',cursor:'pointer',flexShrink:0,transition:'color .2s'}}>{l}</button>
        ))}
      </div>
      {filtered.length===0?(
        <div style={{textAlign:'center',padding:'60px 20px',color:'var(--grey)'}}><div style={{fontSize:38,marginBottom:14,opacity:0.15}}>ğŸ“­</div><div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:26,letterSpacing:-1,textTransform:'uppercase',color:'rgba(255,255,255,0.04)'}}>{listFilter==='all'?'COLECÈšIE GOALÄ‚':'NIMIC AICI'}</div></div>
      ):(
        <div>{filtered.map((a,i)=>{
          const sm=STATUS_META[a.status];const prog=a.episodes&&a.epsWatched?Math.round(a.epsWatched/a.episodes*100):0;
          return(
            <div key={a.mal_id} style={{display:'flex',gap:12,alignItems:'center',padding:mob?'11px 16px':'12px 0',borderBottom:'1px solid var(--border)',transition:'background .15s'}} onMouseEnter={e=>!mob&&(e.currentTarget.style.background='rgba(255,255,255,0.02)')} onMouseLeave={e=>!mob&&(e.currentTarget.style.background='transparent')}>
              <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:12,color:'rgba(255,255,255,0.1)',width:22,flexShrink:0,textAlign:'right'}}>{String(i+1).padStart(2,'0')}</div>
              <img src={a.image_sm||a.image} style={{width:mob?34:38,height:mob?48:54,objectFit:'cover',flexShrink:0}} alt=""/>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:mob?13:15,color:'var(--white)',whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis',marginBottom:3}}>{a.title_english||a.title}</div>
                <div style={{display:'flex',gap:8,flexWrap:'wrap',alignItems:'center'}}>
                  {sm&&<span style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:9,letterSpacing:1.5,textTransform:'uppercase',padding:'1px 6px',border:`1px solid ${sm.color}`,color:sm.color}}>{sm.label}</span>}
                  {a.userScore&&<span style={{fontFamily:'var(--fd)',fontSize:11,color:'var(--gold)',fontWeight:700}}>â˜… {a.userScore}/10</span>}
                  {a.epsWatched>0&&<span style={{fontSize:11,color:'var(--grey2)'}}>ğŸ“º {a.epsWatched}{a.episodes?'/'+a.episodes:''}</span>}
                  {a._fromMAL&&<span style={{fontFamily:'var(--fd)',fontSize:9,letterSpacing:1,textTransform:'uppercase',padding:'1px 5px',background:'rgba(74,158,255,0.12)',border:'1px solid rgba(74,158,255,0.25)',color:'var(--blue)'}}>MAL</span>}
                </div>
                {prog>0&&<div style={{marginTop:4,height:2,background:'rgba(255,255,255,0.06)'}}><div style={{width:`${prog}%`,height:'100%',background:'var(--red)'}}/></div>}
              </div>
              <div style={{display:'flex',gap:6,flexShrink:0}}>
                <button onClick={()=>setEditItem(a)} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:mob?12:10,letterSpacing:mob?0:1.5,textTransform:'uppercase',background:'none',border:'1px solid var(--border)',color:'var(--grey2)',padding:mob?'7px 10px':'7px 11px',cursor:'pointer',transition:'all .2s'}} onMouseEnter={e=>{e.currentTarget.style.color='white';e.currentTarget.style.borderColor='var(--border2)';}} onMouseLeave={e=>{e.currentTarget.style.color='var(--grey2)';e.currentTarget.style.borderColor='var(--border)';}}>
                  {mob?'âœ':'âœ Edit'}
                </button>
                <button onClick={()=>setDelId(a.mal_id)} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:mob?12:10,textTransform:'uppercase',background:'none',border:'1px solid rgba(255,68,68,0.17)',color:'rgba(255,68,68,0.55)',padding:mob?'7px 10px':'7px 11px',cursor:'pointer',transition:'all .2s'}} onMouseEnter={e=>{e.currentTarget.style.color='var(--red)';e.currentTarget.style.borderColor='rgba(230,48,34,0.4)';}} onMouseLeave={e=>{e.currentTarget.style.color='rgba(255,68,68,0.55)';e.currentTarget.style.borderColor='rgba(255,68,68,0.17)';}}>âœ•</button>
              </div>
            </div>
          );
        })}</div>
      )}
    </div>
  );

  return(
    <div style={{minHeight:'100vh',background:'var(--black)'}}>
      {/* Header */}
      <header style={{position:'sticky',top:0,zIndex:400,height:56,display:'flex',alignItems:'center',padding:'0 clamp(16px,4vw,40px)',background:'rgba(0,0,0,0.96)',backdropFilter:'blur(16px)',borderBottom:'1px solid var(--border)'}}>
        <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:18,letterSpacing:4,textTransform:'uppercase',color:'var(--white)',flexShrink:0}}>HIGH<span style={{color:'var(--grey2)'}}>EDITS</span> <span style={{fontSize:10,letterSpacing:3,color:'var(--grey2)',fontWeight:600}}>ADMIN</span></div>
        <div style={{flex:1}}/>
        <button onClick={()=>setSettingsOpen(o=>!o)} title="SetÄƒri" style={{background:'none',border:'none',color:'var(--grey2)',fontSize:18,cursor:'pointer',padding:'6px 10px',transition:'color .2s',marginRight:4,lineHeight:1}} onMouseEnter={e=>e.currentTarget.style.color='white'} onMouseLeave={e=>e.currentTarget.style.color='var(--grey2)'}>âš™ï¸</button>
        <a href="index.html" style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:2,textTransform:'uppercase',color:'var(--grey2)',marginRight:mob?10:18,cursor:'pointer',textDecoration:'none',transition:'color .2s',whiteSpace:'nowrap'}} onMouseEnter={e=>e.currentTarget.style.color='white'} onMouseLeave={e=>e.currentTarget.style.color='var(--grey2)'}>{mob?'Site':'â† Site'}</a>
        <button onClick={()=>{clearSession();onLogout();}} style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:11,letterSpacing:2,textTransform:'uppercase',background:'transparent',color:'rgba(255,68,68,0.55)',border:'1px solid rgba(255,68,68,0.17)',padding:'6px 12px',cursor:'pointer',transition:'all .2s',whiteSpace:'nowrap'}} onMouseEnter={e=>{e.currentTarget.style.color='var(--red)';e.currentTarget.style.borderColor='rgba(230,48,34,0.45)';}} onMouseLeave={e=>{e.currentTarget.style.color='rgba(255,68,68,0.55)';e.currentTarget.style.borderColor='rgba(255,68,68,0.17)';}}>Exit</button>
      </header>

      {/* Settings dropdown */}
      {settingsOpen&&(
        <>
        <div style={{position:'fixed',top:56,right:16,zIndex:450,background:'var(--mid)',border:'1px solid var(--border)',borderTop:'2px solid var(--gold)',minWidth:220,animation:'fadeIn .15s',boxShadow:'0 8px 32px rgba(0,0,0,0.6)'}}>
          <div style={{padding:'8px 0'}}>
            <div style={{fontFamily:'var(--fd)',fontWeight:700,fontSize:9,letterSpacing:3,textTransform:'uppercase',color:'var(--grey)',padding:'8px 16px 4px'}}>SetÄƒri Admin</div>
            <button onClick={()=>{setShowCPass(true);setSettingsOpen(false);}} style={{display:'block',width:'100%',textAlign:'left',fontFamily:'var(--fd)',fontWeight:700,fontSize:13,letterSpacing:1,textTransform:'uppercase',color:'var(--gold)',background:'none',border:'none',padding:'12px 16px',cursor:'pointer'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(255,255,255,0.04)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>ğŸ”‘ SchimbÄƒ Parola</button>
            <button onClick={()=>{setShowImport(true);setSettingsOpen(false);}} style={{display:'block',width:'100%',textAlign:'left',fontFamily:'var(--fd)',fontWeight:700,fontSize:13,letterSpacing:1,textTransform:'uppercase',color:'var(--blue)',background:'none',border:'none',padding:'12px 16px',cursor:'pointer'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(255,255,255,0.04)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>â†“ Import MAL</button>
            <button onClick={()=>{setShowXmlImport(true);setSettingsOpen(false);}} style={{display:'block',width:'100%',textAlign:'left',fontFamily:'var(--fd)',fontWeight:700,fontSize:13,letterSpacing:1,textTransform:'uppercase',color:'var(--green)',background:'none',border:'none',padding:'12px 16px',cursor:'pointer'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(255,255,255,0.04)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>ğŸ“„ Import XML</button>
            <button onClick={()=>{setShowMusicPanel(p=>!p);setSettingsOpen(false);}} style={{display:'block',width:'100%',textAlign:'left',fontFamily:'var(--fd)',fontWeight:700,fontSize:13,letterSpacing:1,textTransform:'uppercase',color:'var(--gold)',background:'none',border:'none',padding:'12px 16px',cursor:'pointer'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(255,255,255,0.04)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>â™ª Playlist MuzicÄƒ</button>
            <div style={{height:1,background:'var(--border)',margin:'4px 0'}}/>
            <button onClick={deleteAll} style={{display:'block',width:'100%',textAlign:'left',fontFamily:'var(--fd)',fontWeight:700,fontSize:13,letterSpacing:1,textTransform:'uppercase',color:'rgba(255,68,68,0.6)',background:'none',border:'none',padding:'12px 16px',cursor:'pointer'}} onMouseEnter={e=>e.currentTarget.style.background='rgba(255,255,255,0.04)'} onMouseLeave={e=>e.currentTarget.style.background='transparent'}>ğŸ—‘ï¸ È˜terge tot</button>
          </div>
        </div>
        <div style={{position:'fixed',inset:0,zIndex:449}} onClick={()=>setSettingsOpen(false)}/>
        </>
      )}

      {/* Stats */}
      <div style={{display:'grid',gridTemplateColumns:mob?'repeat(3,1fr)':'repeat(5,1fr)',background:'var(--dark)',borderBottom:'1px solid var(--border)'}}>
        {[['Total',sc.all,'var(--white)'],['UrmÄƒresc',sc.watching,'#7c8fff'],['Terminate',sc.completed,'#4ecdc4'],['Plan',sc.plan_to_watch,'#ff6b9d'],['Dropped',sc.dropped,'#ff4444']].slice(0,mob?3:5).map(([l,v,c],i)=>(
          <div key={l} style={{padding:mob?'14px 0':'18px 0',textAlign:'center',borderRight:mob?(i<2?'1px solid var(--border)':'none'):(i<4?'1px solid var(--border)':'none')}}>
            <div style={{fontFamily:'var(--fd)',fontWeight:900,fontSize:mob?26:34,lineHeight:1,color:c}}>{v}</div>
            <div style={{fontFamily:'var(--fd)',fontWeight:600,fontSize:9,letterSpacing:2,textTransform:'uppercase',color:'var(--grey2)',marginTop:4}}>{l}</div>
          </div>
        ))}
      </div>

      {/* Content */}
      {mob?(
        <>
        <div style={{display:'flex',background:'var(--dark)',borderBottom:'1px solid var(--border)'}}>
          {[['add','ï¼‹ AdaugÄƒ'],['music','â™ª MuzicÄƒ'],['list',`ğŸ“‹ Lista (${library.length})`]].map(([k,l])=>(
            <button key={k} onClick={()=>setTab(k)} style={{flex:1,fontFamily:'var(--fd)',fontWeight:800,fontSize:mob?11:13,letterSpacing:2,textTransform:'uppercase',padding:'14px 0',background:'none',border:'none',borderBottom:tab===k?'2px solid var(--gold)':'2px solid transparent',color:tab===k?'white':'rgba(255,255,255,0.33)',cursor:'pointer'}}>{l}</button>
          ))}
        </div>
        {tab==='add'?<FormPanel/>:tab==='music'?<MusicPanel showToast={showToast}/>:<ListPanel/>}
        </>
      ):(
        <div style={{display:'grid',gridTemplateColumns:showMusicPanel?'400px 400px 1fr':'400px 1fr',minHeight:'calc(100vh - 145px)',transition:'grid-template-columns .3s'}}>
          <div style={{borderRight:'1px solid var(--border)',background:'var(--dark)'}}><FormPanel/></div>
          {showMusicPanel&&<div style={{borderRight:'1px solid var(--border)',background:'var(--dark)',overflowY:'auto'}}><MusicPanel showToast={showToast}/></div>}
          <div><ListPanel/></div>
        </div>
      )}

      {editItem&&<EditModal anime={editItem} onSave={ch=>saveEdit(editItem.mal_id,ch)} onClose={()=>setEditItem(null)}/>}
      {delId!==null&&<DelConfirm onConfirm={()=>removeAnime(delId)} onClose={()=>setDelId(null)}/>}
      {showImport&&<MalImport library={library} onImport={handleImport} onClose={()=>setShowImport(false)} showToast={showToast}/>}
      {showXmlImport&&<XmlImportModal onImport={handleImport} onClose={()=>setShowXmlImport(false)} showToast={showToast}/>}
      {showCPass&&<ChangePassModal onClose={()=>setShowCPass(false)} showToast={showToast}/>}
      <Toast {...toast}/>
    </div>
  );
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT â€” decides screen based on state
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function AdminApp(){
  const[screen,setScreen]=useState(()=>{
    if(checkSession()) return 'panel';
    if(!getStoredHash()) return 'setup';
    return 'login';
  });
  if(screen==='setup')  return <SetupScreen onSetup={()=>setScreen('panel')}/>;
  if(screen==='login')  return <LoginScreen onLogin={()=>setScreen('panel')}/>;
  return <AdminPanel onLogout={()=>setScreen('login')}/>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<AdminApp/>);
</script>
</body>
</htmla>